<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Database Rotation Dashboard</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow: hidden; /* Ensure content doesn't overflow */
        }

        .card-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #555;
        }

        .card-content {
            font-size: 1em;
            color: #777;
        }
        .status-active {
            color: green;
             font-weight: bold;
        }

        .status-inactive {
            color: red;
            font-weight: bold;
        }


        #log {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #eee;
            height: 200px;
            overflow-y: scroll;
             font-family: monospace;
            white-space: pre-wrap; /* Preserve line breaks and spaces */
        }
        #testButton {
            display: block; /* Make it a block-level element */
            margin: 20px auto; /* Center the button horizontally */
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50; /* Green */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #testButton:hover {
            background-color: #3e8e41;
        }

        #syncButton {
             display: block; /* Make it a block-level element */
            margin: 20px auto;
            padding: 10px 15px;
            font-size: 14px;
            background-color: #007bff; /* Blue */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;

        }
        #syncButton:hover {
              background-color: #0056b3;
        }

        #syncToTargetButton {
            display: block;
            margin: 20px auto;
            padding: 10px 15px;
            font-size: 14px;
            background-color: #f0ad4e; /* Yellow/Orange */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #syncToTargetButton:hover {
            background-color: #ec971f;
        }
       .error-message {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }

    </style>
</head>
<body>
    <h1>Firebase Database Rotation Dashboard</h1>

    <button id="testButton">Simulate User Connections</button>
    <button id="syncButton">Force Synchronization</button>
    <button id="syncToTargetButton">Sync to Target Database</button>
    <div class="dashboard" id="dashboard"></div>
    <h2>Logs</h2>
      <div id="log"></div>

    <script type="module">
        import { getActiveDatabase } from "./firebase-config-manager.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, get, set, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";



        const firebaseConfigs = [
            { databaseURL: "https://cyber1-9c84f-default-rtdb.firebaseio.com" },
            { databaseURL: "https://le-locataire-default-rtdb.firebaseio.com" },
            { databaseURL: "https://espoirplus-d68c2-default-rtdb.firebaseio.com" },
            { databaseURL: "https://wifi-zone-tanto-default-rtdb.firebaseio.com" },
            { databaseURL: "https://cine-evisions-default-rtdb.firebaseio.com" },
            { databaseURL: "https://campus-b1d76-default-rtdb.firebaseio.com" },
            { databaseURL: "https://eduque-moi-374cb-default-rtdb.firebaseio.com" },
            { databaseURL: "https://eduque-moi-bada8-default-rtdb.firebaseio.com" },
            { databaseURL: "https://eduque-moi-lite-default-rtdb.firebaseio.com" },
            { databaseURL: "https://evisions-9196f-default-rtdb.firebaseio.com" },
            { databaseURL: "https://mon-logement-d930b-default-rtdb.firebaseio.com" },
            { databaseURL: "https://mon-tuteur-42271-default-rtdb.firebaseio.com" },
            { databaseURL: "https://my-save-fa5fa-default-rtdb.firebaseio.com" },
            { databaseURL: "https://paj-market-edd38-default-rtdb.firebaseio.com" },
            { databaseURL: "https://pajmarket-default-rtdb.firebaseio.com" },
            { databaseURL: "https://save-2-95c36-default-rtdb.firebaseio.com" },
            { databaseURL: "https://svterminal-4de34-default-rtdb.firebaseio.com" },
            { databaseURL: "https://test-2f1c1-default-rtdb.firebaseio.com" },
            { databaseURL: "https://tontine-4a303-default-rtdb.firebaseio.com" },
            { databaseURL: "https://idealer-6a95b-default-rtdb.firebaseio.com" }
            // Add more configurations as needed
        ];
         const META_DB_INDEX = 0;
        const MAX_CONNECTIONS = 1000;
        const targetDatabaseURL = "https://test-d5828-default-rtdb.firebaseio.com"; // Target DB
        const SYNC_NODE_PATH = "syncStatus"; // Le chemin du nœud de synchronisation
        const SYNC_DONE_VALUE = "synced";    // La valeur indiquant une synchronisation effectuée


        function logMessage(message) {
            const logElement = document.getElementById('log');
            logElement.textContent += message + '\n';
            logElement.scrollTop = logElement.scrollHeight; // Auto-scroll to bottom
        }

        function initializeAppWithIndex(index) {
            const config = firebaseConfigs[index];
            if (!config) {
                throw new Error(`Invalid database index: ${index}`);
            }
            const appName = `app${index}`;
            try {
                return initializeApp(config, appName);
            } catch (error) {
                if (error.code === 'app/duplicate-app') {
                    // App already initialized, use existing instance
                    return firebase.app(appName); // Use firebase.app (classic namespace)
                } else {
                    throw error; // Re-throw unexpected errors
                }
            }
        }

        function initializeTargetApp() {
            try {
                // Use a fixed name so we don't create multiple apps.
                const targetApp = initializeApp({ databaseURL: targetDatabaseURL }, "targetApp");
                return getDatabase(targetApp);
              } catch (error) {
                if (error.code === 'app/duplicate-app') {
                    // App already initialized, use existing instance
                    return getDatabase(firebase.app("targetApp"));
                } else {
                    throw error; // Re-throw unexpected errors
                }
            }
        }

        // Vérifie si la synchronisation a été effectuée sur cette base de données.
        async function hasSyncOccurred(db) {
            const syncRef = ref(db, SYNC_NODE_PATH);
            const snapshot = await get(syncRef);
            return snapshot.exists() && snapshot.val() === SYNC_DONE_VALUE;
        }

        // Marque la synchronisation comme effectuée sur cette base de données.
        async function markSyncAsDone(db) {
            const syncRef = ref(db, SYNC_NODE_PATH);
            await set(syncRef, SYNC_DONE_VALUE);
        }


        async function getOrCreateConnectionCounter(db, index) {
            const counterRef = ref(db, 'connectionCounter');
            const snapshot = await get(counterRef);
            if (!snapshot.exists()) {
                await set(counterRef, 0);
                 logMessage(`Connection counter initialized for database ${index + 1}`);
                return 0;
            }
             logMessage(`Connection counter value ${snapshot.val()} for database ${index + 1}`);
            return snapshot.val();
        }


        async function getCurrentDatabaseIndex() {
            const metaDb = initializeAppWithIndex(META_DB_INDEX);
            const metaDbInstance = getDatabase(metaDb);
            const indexRef = ref(metaDbInstance, 'currentDatabaseIndex');
            const snapshot = await get(indexRef);
            if (snapshot.exists()) {
                 logMessage(`Current Index in Metadb: ${snapshot.val()}`);
                return snapshot.val();
            } else {
                // Initialize if it doesn't exist.
                await set(indexRef, 0);
                 logMessage(`Current Index initialized in Metadb: 0`);
                return 0;
            }
        }

        async function clearOtherSyncStatuses(currentDatabaseIndex) {
            for (let i = 0; i < firebaseConfigs.length; i++) {
                if (i !== currentDatabaseIndex) {
                    const app = initializeAppWithIndex(i);
                    const dbInstance = getDatabase(app);
                    const syncRef = ref(dbInstance, SYNC_NODE_PATH);
                    const snapshot = await get(syncRef);

                    if (snapshot.exists() && snapshot.val() === SYNC_DONE_VALUE) {
                        await set(syncRef, null); // Or deleteObject(syncRef) if you prefer
                        logMessage(`Cleared syncStatus for database ${i + 1}`);
                    }
                }
            }
        }


    async function updateDashboard() {
        const dashboardElement = document.getElementById('dashboard');
        const currentDatabaseIndex = await getCurrentDatabaseIndex();

        // Clear syncStatus on other databases *before* updating the dashboard
        await clearOtherSyncStatuses(currentDatabaseIndex);

        for (let i = 0; i < firebaseConfigs.length; i++) {
            const app = initializeAppWithIndex(i);
            const db = getDatabase(app);
            const connectionCount = await getOrCreateConnectionCounter(db, i);
            const syncStatus = await hasSyncOccurred(db); // Vérifie l'état de synchronisation

            // Try to get existing card, if not, create it
            let card = document.getElementById(`card-${i}`);
            if (!card) {
                card = document.createElement('div');
                card.classList.add('card');
                card.id = `card-${i}`; // Set the ID here
                dashboardElement.appendChild(card);

                const title = document.createElement('div');
                title.classList.add('card-title');
                title.textContent = `Database ${i + 1}`;
                card.appendChild(title);

                const content = document.createElement('div');
                content.classList.add('card-content');
                card.appendChild(content); // Append content div to card
            }

            // Update the content of the card
            const contentDiv = card.querySelector('.card-content'); // Select the content div inside the card
            const statusText = `<span class="${i === currentDatabaseIndex ? 'status-active' : 'status-inactive'}">${i === currentDatabaseIndex ? 'Active' : 'Inactive'}</span>`;
            contentDiv.innerHTML = `
                URL: ${firebaseConfigs[i].databaseURL}<br>
                Connections: ${connectionCount} / ${MAX_CONNECTIONS}<br>
                Status: ${statusText}<br>
                Synchronized: ${syncStatus ? 'Yes' : 'No'}
            `; // Ajoute l'état de synchronisation
        }
    }

    async function simulateConnection() {
        try {
            const db = await getActiveDatabase(); // Get the active database
            logMessage("Simulated connection successful.");

        } catch (error) {
            logMessage(`Error simulating connection: ${error.message}`);

        }
        finally{
             updateDashboard();
        }
    }
    async function forceSync() {
       try {

            let currentDatabaseIndex = await getCurrentDatabaseIndex();
            const oldIndex = currentDatabaseIndex;
            currentDatabaseIndex = (currentDatabaseIndex + 1) % firebaseConfigs.length;
            logMessage(`Manual Sync : Switching to database index: ${currentDatabaseIndex}`);
           //Synchronisation
            await synchronizeData(oldIndex, currentDatabaseIndex);
            //update current index
             const metaDb = initializeAppWithIndex(META_DB_INDEX);  // Always use the first config for meta-data
            const metaDbInstance = getDatabase(metaDb);
            const indexRef = ref(metaDbInstance, 'currentDatabaseIndex');
            await set(indexRef, currentDatabaseIndex);
             logMessage(`Manual Sync : Current Index in Metadb updated: ${currentDatabaseIndex}`);

        } catch (error) {
             logMessage(`Error Forcing synchronization: ${error.message}`);
        }
        finally{
          updateDashboard();
        }
    }

   async function synchronizeData(oldIndex, newIndex) {
    if (oldIndex === -1) return; // Pas de synchronisation si c'est la première initialisation

     logMessage("Starting database synchronization...");

    const oldDbApp = initializeAppWithIndex(oldIndex);
    const newDbApp = initializeAppWithIndex(newIndex);

    const oldDb = getDatabase(oldDbApp);
    const newDb = getDatabase(newDbApp);

    const dataPathsToSync = ['users', 'users-data'];

    for (const path of dataPathsToSync) {
        try {
            const oldDataRef = ref(oldDb, path);
            const newDataRef = ref(newDb, path);
            const snapshot = await get(oldDataRef);
            const dataToSync = snapshot.val();

            if (dataToSync) {
                await set(newDataRef, dataToSync);
                 logMessage(`Data synchronized for path: ${path}`);
            }
        } catch (error) {
             logMessage(`Error synchronizing path ${path}: ${error}`);
            throw new Error(`Error during synchronization: ${error.message}`);
        }
    }
     logMessage("Database synchronization complete.");
    //Important : reinitialisation du compteur a 0 apres synchronisation
    await set(ref(oldDb, 'connectionCounter'), 0);
}

async function syncToTarget() {
    try {
        logMessage("Starting synchronization to target database...");
        const currentDb = await getActiveDatabase();

        if (!(await hasSyncOccurred(currentDb))) {
           await synchronizeToTargetDatabase(currentDb);
           await markSyncAsDone(currentDb);
           logMessage("Forced Synchronization to target database and Marked complete.");

        }
        else{
           logMessage("The database is already synchronized with the Target database.");
        }

    } catch (error) {
        logMessage(`Error synchronizing to target: ${error.message}`);
    } finally {
        updateDashboard(); // Update counts after sync
    }
}

async function synchronizeToTargetDatabase(currentDb) {
    const targetDb = initializeTargetApp();
    const dataPathsToSync = ['users', 'users-data'];

    for (const path of dataPathsToSync) {
        try {
            const currentDataRef = ref(currentDb, path);
            const targetDataRef = ref(targetDb, path);
            const snapshot = await get(currentDataRef);
            const dataToSync = snapshot.val();

            if (dataToSync) {
                await set(targetDataRef, dataToSync);
                logMessage(`Data synchronized for path: ${path} to target DB`);
            }
        } catch (error) {
            logMessage(`Error synchronizing path ${path}: ${error}`);
            throw new Error(`Error during synchronization to target: ${error.message}`);
        }
    }
    logMessage("Database synchronization to target complete.");
}

    // Initial dashboard update
    updateDashboard();
    // Set up interval for periodic updates
    setInterval(updateDashboard, 10000); // Update every 10 seconds


     document.getElementById('testButton').addEventListener('click', () => {
        const numConnections = 50; // Or however many you want to simulate
        for (let i = 0; i < numConnections; i++) {
             simulateConnection();
        }
     });

    document.getElementById('syncButton').addEventListener('click', forceSync);
    document.getElementById('syncToTargetButton').addEventListener('click', syncToTarget); // Add event listener


    </script>
</body>
</html>